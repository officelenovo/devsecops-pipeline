name: DevSecOps Security Pipeline

on:
  push:
  pull_request:

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # ----------------------
    # SAST - Semgrep
    # ----------------------
    - name: Run Semgrep (SAST)
      uses: semgrep/semgrep-action@v1
      with:
        config: p/owasp-top-ten
      env:
        SEMGREP_APP_TOKEN: ""   # Not required for OSS
      continue-on-error: true

    # ----------------------
    # Secrets Scanning - Gitleaks
    # ----------------------
    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      continue-on-error: true

    # ----------------------
    # Dependency Scanning - OWASP Dependency-Check
    # ----------------------
    - name: Run Dependency-Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: "devsecops-pipeline"
        path: "."
        format: "SARIF"
        out: "dependency-check-report"
      continue-on-error: true

    # ----------------------
    # Upload Reports
    # ----------------------
    - name: Upload Dependency Report
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-report
        path: dependency-check-report

    # ----------------------
    # Policy Gate
    # ----------------------
    - name: Security Gate
      run: |
        echo "Failing pipeline if high risk issues are found"
        exit 1
